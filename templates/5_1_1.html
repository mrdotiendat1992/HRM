{% extends  "base.html" %}
{% block style%}
<style>
    table, th, td {
        font-size: 12px;
    }
    th {
        text-align: center;
        color: white;
    }
    .a_target {
        font-weight: bold;
        color: purple;
    }
    .b_target {
        font-weight: bold;
        color: green;
    }
    .c_target {
        font-weight: bold;
        color: red;
    }
    #actual_result {
        width:100%;
        height: 100%;
    }
</style>
{% endblock style %}
{% block content %}
<div class="container-fluid">
    <table class="table table-bordered">
        <thead>
            <tr class="bg-primary">
                <th rowspan="2" style="vertical-align: middle;">No.</th>
                <th rowspan="2" style="vertical-align: middle;">Department</th>
                <th rowspan="2" style="vertical-align: middle;">Objectives</th>
                <th rowspan="2" style="vertical-align: middle;">Possible measures</th>
                <th rowspan="2" style="vertical-align: middle;">Unit of measurement</th>
                <th rowspan="2" style="vertical-align: middle;">Measurement Source</th>
                <th colspan="3">Target</th>
                <th rowspan="2" style="vertical-align: middle;">Month</th>
                <th rowspan="2" style="vertical-align: middle;">Year</th>
                <th rowspan="2" style="vertical-align: middle;">Actual result</th>
            </tr>
            <tr class="bg-info">
                <th class="a_target">A</th>
                <th class="b_target">B</th>
                <th class="c_target">C</th>
            </tr>
        </thead>
        <tbody>
            {% for row in danhsachdong %}
            <tr data-info='{{ row  | safe }}'>
                <td>{{loop.index}}</td>
                <td>{{row["Department"]}}</td>
                <td>{{row["Objective"]}}</td>
                <td>{{row["Possible measures"]}}</td>
                <td>{{row["Unit of measurement"]}}</td>
                <td>{{row["Measurement source"]}}</td>                
                <td class="a_target">{{row["A target"]}}</td>
                <td class="b_target">{{row["B target"]}}</td>
                <td class="c_target">{{row["C target"]}}</td>
                <td>{{month}}</td>
                <td>{{year}}</td>
                <td>
                    <input type="text" name="actual_result" class="actual_result" onchange="save_row(event)">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button class="btn btn-primary" id="saveBtn">Save</button>
    <div id="output"></div>
</div>
<script>
    var savedRows = ['{{current_user.macongty}}', '{{current_user.masothe}}', '{{current_user.hoten}}'];

    function save_row(event) {
        const row = event.target.closest('tr');
        const rowData = {
            no: row.cells[0].innerText,
            department: row.cells[1].innerText,
            objectives: row.cells[2].innerText,
            possibleMeasures: row.cells[3].innerText,
            unitOfMeasurement: row.cells[4].innerText,
            measurementSource: row.cells[5].innerText,
            aTarget: row.cells[6].innerText,
            bTarget: row.cells[7].innerText,
            cTarget: row.cells[8].innerText,
            month: row.cells[9].innerText,
            year: row.cells[10].innerText,
            actualResult: row.querySelector('input.actual_result').value
        };
        
        // Remove existing entry for this row (if any)
        const index = savedRows.findIndex(r => r.no === rowData.no);
        if (index !== -1) {
            savedRows[index] = rowData;
        } else {
            savedRows.push(rowData);
        }
    }

    document.getElementById('saveBtn').addEventListener('click', () => {
        var data = JSON.stringify(savedRows, null, 2);
        axios({
            method: 'post',
            url: '/themdulieukpi',
            data: data,
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(function (response) {
            alert("Saved your " + {{month}} + "/" + {{year}} +" perfomance successfully");
            window.location.reload();
        })
        .catch(function (error) {
            console.log(error);
        });
    });

</script>

{% endblock content %}
